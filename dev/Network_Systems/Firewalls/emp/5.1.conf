# FILE:		5.1.conf
# AUTHOR:	Michael Spence
# DATE:		2012-07-20
#
# PURPOSE::
# 	AP Eagers Firewall Config
#

##### ##### MACROS ##### #####
# Interfaces
if_ext =		"em0"   # External Interface
if_int =		"em1"   # Internal Interface


# INCLUDE SPECIFIC CONFIGURATIONS
# -- Raw access
include "/etc/pf/raw.5.1.conf"

# -- Proxy servers
include "/etc/pf/proxy.5.1.conf"

# -- Firewall bypass Sites
include "/etc/pf/sites.5.1.conf"

# -- Remote Access Rules
include "/etc/pf/remote.5.1.conf"



##### PORTS
# Proxy internet ports
pts_inet =		"80 443 3128"

# Citrix Ports
citrix_ports =		"80 443 1494 2598 2512 2513 8080"
ports_ctx1 =		"443"
ports_ctx2 =		"80 443"
ports_ctx3 =		"80 443 1494"

volvo_ports =		"5031 449 8470:8476"


# Connection Ports
port_bma_cctv1 = 	"50000"
port_bma_ccweb = 	"50001"

#MSN Messenger Ports
pts_msn =		"1493 1542 1863 1963"

# File Sharing PTP
pts_tor =		"6881 37001 37002 37003 37000"
pts_p2p =		"1214 5000 5555 6346 777 8331 8875 8888 6257 6699"
pt_cvsup =		"5999"
pt_pptp =		"1723"

# Instant Messaging Clients
pt_jabber =		"5222"
pt_icqaim =		"5190"
pt_irc =		"6667"

# Macromedia Flash RTMP
pt_rtmp =		"1935 554"
pt_apple =		"5223"

# BAD PORTS
pts_bad =		$pts_msn $pts_tor $pts_p2p $pt_cvsup $pt_pptp $pt_jabber $pt_icqaim $pt_irc $pt_rtmp $pt_apple

##### A.P. EAGERS DATA CENTRE
# External Addresses
ext_owa_qld =		"203.38.61.193"		# OWA Ext (aka owa.apeagers.com.au)
ext_194 =		"203.38.61.194"		# TEMP ERANET RDP  == TUNE !!!
ext_195 =		"203.38.61.195"		# TEMP ERANET RDP
ext_196 =		"203.38.61.196"		# TABLET CITRIX
ext_197 =		"203.38.61.197"		# REMOTE CITRIX
ext_198 =		"203.38.61.198"		# TEMP CITRIX
ext_ftp_zoos =		"203.38.61.199"		# Carzoos FTP
ext_ftp_qld1 =		"203.38.61.203"		# AP Eagers FTP
ext_ftp_qld2 = 		"203.38.61.204"		# Carzoos FTP
ext_citrix =		"203.38.61.205"		# NFuse Ext (aka citrix.apeagers.com.au)
ext_intranet =		"203.38.61.206"		# Intranet Ext

# Internal Addresses
int_aus_intranet =	"10.1.1.50"
int_bne_apps =		"10.1.1.93"
int_bne_btac =		"10.1.1.8"
int_bne_caplink =	"10.1.1.41"
int_bne_dax09 =		"10.1.1.22"
int_bne_dc2 =		"10.1.1.42"
int_bne_eranet = 	"10.1.1.25 10.1.11.9 10.1.1.9" 
int_bne_iis =		"10.1.1.90"
int_bne_isa =		"10.1.1.18"
int_bne_mx1 =		"10.1.0.32"
int_citrixgabba =	"10.1.1.6"
int_corp_board =	"10.16.100.90"
int_dwn_eranet =	"10.1.1.48"
int_intranet =		"10.1.1.13"
int_inf_media =		"10.11.254.100"		# Infinity Media Stream (BOSE) -- MS 2013-01-17
int_mgmt_if =		"192.168.248.0/24"
int_qld_cit1 =		"10.1.1.65"
int_qld_csp =		"10.1.1.80"
int_qld_isa =		"10.1.1.59"
int_qld_tftp =		"10.1.1.24"
int_dcs_net =		"10.40.1.36"
int_vga_juniper = 	"10.1.1.240"		# Internal Facing interface of Juniper
int_ssh_mbox =		"10.2.7.239"
int_ewn_ava =		"10.12.254.199"
int_vexecera =		"10.1.1.11"
int_bma_cctv =		"10.32.3.150"
int_nos_box =		"10.1.1.7"
int_temsvr =		"10.1.254.5"

int_tune_qld =		"10.36.1.2"
int_tune_nla = 		"10.25.4.2"
int_tune_ttb =		"10.36.4.2"

int_qld_titan =		"10.1.100.21"

int_gk =		"10.1.1.18"

b2b_rnr_fis = 		"10.40.1.51"
b2b_vga_juniper =	"10.40.1.61"		# External Facing interface of Juniper

#dms_era1 =		"172.20.3.40"
#dms_era2 =		"172.20.3.41"

inet_butterfly = 	"210.15.233.194"
inet_gen_e =		"59.167.181.41"
inet_tmca =		"203.53.49.244 203.53.49.245"
inet_revolution =	"203.36.194.133"

##### A.P. EAGERS SITES
ape_billbuckles =	"203.43.230.186"
ape_klosters =		"203.38.221.86"
ape_surfers =		"210.56.85.111, 210.56.85.112"
ape_darwin =		"203.43.230.178"
ape_newstead =		"139.130.41.14"
ape_queensland =	"165.228.157.90"
ape_adtrans =		"210.8.187.102"

###################################################################################################################
##### ##### TABLES ##### #####
# INTERNAL SOURCES
# Hosts allowed Un-filtered Internet Access
int_raw = 		10.32.77.77 10.32.100.77 10.1.0.10 10.1.100.20 10.32.100.254 10.1.1.92
table <int_raw> const { $int_raw }

table <int_tune> const { $int_tune_qld $int_tune_nla $int_tune_ttb }

# Hosts allowed HTTP, HTTPS or SQUID internet access
int_proxy =		$int_bne_btac $int_bne_caplink $int_bne_dc2 $int_bne_eranet $int_dcs_net $int_dwn_eranet $int_ssh_mbox \
			$int_ewn_ava $int_bne_isa $int_qld_isa $int_qld_csp $int_temsvr 10.10.16.201 10.32.254.10 10.1.1.32 \
			10.1.1.31 10.35.18.100 10.1.1.49 10.1.1.43 $int_inf_media $int_corp_board
table <int_proxy> const { $int_proxy }

b2b_proxy =		$b2b_rnr_fis $b2b_vga_juniper
table <b2b_proxy> const { $b2b_proxy }

# Hosts allowed SMTP internet access
int_mail =		10.1.0.10 10.1.1.10 10.1.1.32 10.1.1.33 10.1.1.50
table <int_mail> const { $int_mail }

table <internal_sources> const { $int_raw $int_proxy $b2b_proxy $int_mail }

# INTERNET DESTINATIONS
table <inet_bad> const { 83.140.247.20 32.60.9.237 32.60.13.237 123.2.106.220 203.175.187.177 64.4.23.156 178.248.142.82 \
			95.29.220.54 94.50.144.89 61.216.248.124 122.149.42.218 61.216.248.124 142.167.71.27 \
			211.31.205.117 17/8 }


##### EXTERNAL HOSTS
table <ext_ctxs> const { $ext_196, $ext_197 }

##### EXTRANET NETWORKS
table <xnet_audi> const { 10.112.192.0/24, 10.166.145.0/24 }
table <xnet_vw> const { 10.112.198.0/24, 10.112.230.0/24, 10.152.15.0/24, 172.16.61.0/24, 210.193.223.156 }
table <xnet_toyota> const { 10.9.100.0/24, 132.147.0.0/16, 150.45.0.0/16, 192.168.42.0/24, 192.168.101.0/24, 192.168.108.0/24, 192.168.109.0/24, 192.168.206.0/24 }

table <xnet_volvo> const { 212.181.101.128/25,  212.181.102.0/24, 212.181.103.0/24 }

##### INTERNET HOSTS
table <inet_vwaudi> const { 59.154.32.6, 61.88.114.38, 119.225.2.78, 210.48.210.1 }
table <inet_tune> const { $inet_tmca $inet_revolution 139.130.41.14 }

table <inet_vital> const { 203.206.162.162 202.125.173.39 1/8 139.130.41.14 }
table <inet_titan> const { 203.206.169.89 203.217.12.189 203.59.99.218 203.59.134.193 }

##### A.P. EAGERS SITES
table <ape_sites> const { $ape_billbuckles, $ape_klosters, $ape_surfers, $ape_darwin, $ape_newstead, $ape_queensland, $ape_adtrans }

table <remote_svrs> const { $int_tune_qld, $int_tune_nla, $int_tune_ttb, $int_bma_cctv, $int_gk }

###################################################################################################################
##### ##### ##### OPTIONS ##### ##### #####
# Skip Rules for loopback interface
set skip on lo
set block-policy drop
set loginterface em0
set limit states 40000
set optimization conservative

###################################################################################################################
##### ##### ##### NORMALISATION ##### ##### #####
# Scrub
scrub in all

###################################################################################################################
##### ##### ##### TRANSLATION ##### ##### #####
# Default NAT/RDR
nat on $ext_if from <internal_sources> -> ($ext_if:0)
#nat on $ext_if proto { tcp, udp } from <internal_sources> to any port { 80, 443, 3128 } -> ($ext_if:0)
nat on $ext_if proto { tcp, udp } from any to any port domain -> ($ext_if:0)
nat on $ext_if proto icmp from !($ext_if) -> ($ext_if:0)

##### EXTRANET NATS
nat on $int_if from any to <xnet_audi> -> $int_if
nat on $int_if from any to <xnet_vw> -> $int_if
nat on $int_if from any to <xnet_toyota> -> $int_if

nat on $ext_if proto tcp from any to <ape_sites> port 3389 -> ($ext_if:0)

# NAT for DWN ERA *** pah046.ford.com (via Autogrid) ***
# nat on $b2b_if from $dms_era1 to 19.190.18.11 -> $b2b_if

# NAT for remote servers (ie not at data centre)
nat on $int_if from any to <remote_svrs> -> $int_if

# FTP Anchor
nat-anchor "ftp-proxy/*"
rdr-anchor "ftp-proxy/*"
rdr on $int_if proto tcp from any to any port ftp -> 127.0.0.1 port 8021

rdr on $int_if proto tcp from any to 17.171.4.35 port 123 -> 10.1.1.43 port 123

##### REMOTE SERVER ACCESS
# Terminal Services Gateway
rdr on $ext_if proto tcp from any to (em0:0) port https -> $int_gk port https

# Redirect from APEagers Sites to FTP servers and Intranet
#rdr on $ext_if proto tcp from <inet_vital> to $ext_ftp_zoos port ftp -> $int_qld_tftp port 8021
rdr on $ext_if proto tcp from <inet_vital> to $ext_ftp_zoos port { ftp-data 2024:65535 } -> $int_qld_tftp

rdr on $ext_if proto tcp from <inet_vital> to $ext_ftp_zoos port 1122 -> $int_qld_tftp port 22
rdr on $ext_if proto tcp from <ape_sites> to $ext_ftp_qld1 port { ftp 49151:65535 } -> $int_bne_iis
rdr on $ext_if proto tcp from <ape_sites> to $ext_ftp_qld2 port { ftp 49152:65535 } -> $int_bne_dax09
rdr on $ext_if proto tcp from <ape_sites> to $ext_intranet port www -> $int_aus_intranet

rdr on $ext_if proto tcp from any to any port $port_bma_cctv1 -> $int_bma_cctv port 6100
rdr on $ext_if proto tcp from any to any port $port_bma_ccweb -> $int_bma_cctv port 80

# Redirect to Citrix and OWA
rdr on $ext_if proto tcp from any to <ext_ctxs> port { $citrix_ports } -> $int_qld_cit1
rdr on $ext_if proto tcp from any to $ext_citrix port { $citrix_ports } -> $int_citrixgabba

# Redirect Butterfly to Intranet
rdr on $ext_if proto tcp from $inet_butterfly to any port { ssh http https } -> $int_aus_intranet

# TITAN RDP
rdr on $ext_if proto tcp from <inet_titan> to $ext_194 port 3389 -> $int_qld_titan port 3389

# TEMPORARY ERANET RDP
#rdr on $ext_if proto tcp from any to $ext_195 port 3389 -> 10.1.1.9

# Redirect VW VGA Juniper
rdr on $ext_if from <inet_vwaudi> to any -> $b2b_vga_juniper # VW/Audi VPN to Ext int of VGA Juniper

# Redirect Executive Anywhere web traffic
#rdr on $b2b_if proto { tcp, udp } from any to any port 17280 -> $int_vexecera port 80

# Redirect Darwin ERA Telnet traffic
rdr on $int_if proto { tcp, udp } from any to any port 17240 -> 172.20.3.40 port 23

# Redirects for Tune access to Servers
#rdr on $ext_if proto tcp from <inet_tune> to $ext_194 port 33890 -> $int_tune_qld port 3389
#rdr on $ext_if proto tcp from <inet_tune> to $ext_194 port 33891 -> $int_tune_nla port 3389
#rdr on $ext_if proto tcp from <inet_tune> to $ext_194 port 33892 -> $int_tune_ttb port 3389

# Redirects for Apps TS Server
rdr on $ext_if proto tcp from any to $ext_197 port 33890 -> $int_bne_apps port 3389

rdr on $ext_if proto tcp from <inet_tune> to $ext_194 port { ftp-data ftp 49152:65535 } -> 10.1.4.11

###################################################################################################################
##### ##### ##### FILTERING ##### ##### #####
# FTP Anchor
anchor "ftp-proxy/*"

# Default deny
block in log all
pass out log quick on $ext_if from ($ext_if:0) to any
block out log quick on $ext_if

# Raw Internet
pass in log quick on $int_if proto { tcp, udp } from <int_raw> to any 
pass in log quick on $ext_if proto { tcp, udp } from any to <int_raw>

# Block Bad Internet
block in log quick on $ext_if from <inet_bad> to any
block in log quick on $ext_if from any to <inet_bad>

# Mail Traffic
#pass in log quick on $int_if proto { tcp, udp } from <int_mail> to any port 25
pass in log quick on $int_if proto { tcp, udp } from <int_mail> to any

# Proxy Servers Can access Internet
pass in quick on $int_if proto { tcp, udp } from <int_proxy> to any port { $pts_inet }
pass in quick on $int_if proto { tcp, udp } from <b2b_proxy> to any port { $pts_inet }

# Pass VGA Internet traffic to Juniper
pass in log quick on $ext_if from <inet_vwaudi> to $b2b_vga_juniper keep state

# Pass Volvo Internet traffic
pass in log quick on $int_if proto { tcp, udp } from any to <xnet_volvo> port { $volvo_ports }

##### REMOTE SERVER ACCESS
# Terminal Services Gateway
pass in log quick on $ext_if proto tcp from any to $int_gk port https keep state

# Allow access from APEagers Sites to FTP servers and Intranet
pass in log quick on $ext_if proto tcp from <inet_vital> to $ext_ftp_zoos port 21
pass in log quick on $ext_if proto tcp from <inet_vital> to $int_qld_tftp port { ftp-data ftp 1024:65535 }
pass in log quick on $ext_if proto tcp from <inet_vital> to $int_qld_tftp port 22
pass in log quick on $ext_if proto tcp from <ape_sites> to $int_bne_iis port { ftp 49152:65535 }
pass in log quick on $ext_if proto tcp from <ape_sites> to $int_bne_dax09 port { ftp 49152:65535 }
pass in     quick on $ext_if proto tcp from <ape_sites> to $int_aus_intranet port www 

# Allow access to APEagers Sties via RDP
pass out log quick on $ext_if proto tcp from any to <ape_sites> port 3389

pass in log quick on $ext_if proto tcp from any to $int_bma_cctv port 6100 keep state
pass in log quick on $ext_if proto tcp from any to $int_bma_cctv port 80 keep state

pass in log quick on $ext_if proto tcp from $inet_butterfly to $int_aus_intranet

pass in log quick on $ext_if proto tcp from any to $int_bne_apps port 3389 keep state

pass in log quick on $ext_if proto tcp from <inet_titan> to $int_qld_titan port 3389 keep state

pass in log quick on $ext_if proto tcp from <inet_tune> to <int_tune> port 3389 keep state
pass in log quick on $ext_if proto tcp from <inet_tune> to 10.1.4.11 port { ftp-data ftp 49152:65535 }

# Allow access to Citrix and OWA
pass in log quick on $ext_if proto tcp from any to $int_citrixgabba port { $citrix_ports }
pass in log quick on $ext_if proto tcp from any to $int_qld_cit1 port { $citrix_ports }

##### OTHER INTERFACE RULES
# Allow all traffic out. 
pass out all

# Pass in internal traffic
pass on $int_if no state
pass out on $int_if from any to any keep state

# Antispoof loopback
antispoof quick for { lo $int_if }

# Allow DNS transfers and queries
pass in quick on { $int_if } proto { tcp, udp } from any port domain to any keep state
pass in quick on { $int_if } proto { tcp, udp } from any to any port domain keep state
