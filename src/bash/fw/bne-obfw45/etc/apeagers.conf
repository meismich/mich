#############################
# AP Eagers Firewall Config
#
# Author: Mark Cross - Senior Systems Engineer - AP Eagers Ltd
#
# Last change: 24/12/2009
# Description: block p80 out apart from proxy server
#############################

# Default parameters
set require-order no
set skip on lo

#++++++++++++++
#++++++++++++++
# Macros START
#++++++++++++++
#++++++++++++++

# Interfaces
ext_if="vic0"   # External Interface
int_if="vic1"   # Internal Interface
dms_if="vic2"   # DMS Interface
b2b_if="vic3"   # B2B Interface

# Proxy internet ports
inet_ports="{ 80, 443 }"

# Additional Ext IP addresses
ext_194="203.38.61.194"

#--------------
# Servers BEGIN
#--------------

ape_ftp_ext="203.38.61.203"	# AP Eagers FTP
bne_dax09="10.1.1.22"		# bne-dax09
bne_iis="10.1.1.9"		# bne-iis
bne_mx1="10.1.1.32"		# bne-mx1
carzoos_ftp_ext="203.38.61.204"	# Carzoos FTP
citrix_ext="203.38.61.205"	# NFuse Ext
citrix_int="10.1.1.6"		# NFuse Int
intranet_ext="203.38.61.206"	# Intranet Ext
intranet_int="10.1.1.13"	# Intranet Int
owa_ext="203.38.61.193"		# OWA Ext
proxy_svrs="{ 10.1.254.45, 10.1.1.8, 10.1.1.18, 10.1.1.25, 10.1.1.41, 10.1.1.42, 10.1.1.48, 10.1.1.49, 10.1.1.59, 10.1.1.68, 10.1.1.69, 10.1.11.9, 10.2.254.1, 10.25.4.16, 10.34.1.68, 10.34.1.69, 10.35.1.111, 10.34.100.71, 10.40.1.51, 192.168.248.0/24 }"
vga_juniper_ext="10.40.1.61"
vga_juniper_int="10.1.1.240"

#--------------
# Servers END
#--------------

#----------------------------
# Manufacturer Networks START
#----------------------------

audi_sites="{ 10.112.192.0/24, 10.112.230.0/24, 10.166.145.0/24, 61.88.114.35 }"
autogrid_sites="{ 19.197.2.93, 19.197.2.171, 19.197.2.183, 19.197.6.35, 136.8.159.0/24, 136.9.242.0/24, 136.9.246.0/24, 136.9.249.0/24, 136.9.252.0/24, 136.130.208.0/24, 192.28.103.0/24, 193.129.10.228, 19.110.66.48 }"
bma_sites="{ 210.8.199.67, 210.8.223.54 }"
capital_finance="202.160.110.10"
citroen_sites="{ 74.125.19.147, 81.255.178.161, 194.250.98.65, 203.210.109.237 }"
dealerlink_sites="{ 10.20.0.0/16, 10.21.0.0/16, 10.30.0.0/16, 10.31.0.0/16, 10.40.3.0/24, 10.40.5.0/24, 10.40.6.0/24, 10.40.7.0/24, 10.40.9.0/24, 10.41.0.0/16, 10.81.7.0/24, 10.81.12.0/24, 10.81.34.0/24, 10.81.51.0/24, 10.81.60.0/24, 10.81.80.0/24, 10.81.105.0/24, 10.81.114.0/24, 10.81.122.0/24, 10.81.127.0/24, 10.81.142.0/24, 10.81.168.0/24, 10.81.174.0/24, 10.81.205.0/24, 10.81.241.0/24, 10.82.6.0/24, 10.85.41.0/24, 10.100.12.0/24, 100.100.150.0/24, 122.122.125.5, 122.122.125.30, 172.20.3.66, 172.20.3.98, 172.20.3.132, 172.20.3.162, 172.20.3.194, 172.20.4.34, 192.168.0.5, 192.168.3.0/24, 192.168.24.0/24, 192.168.30.0/24, 203.13.244.0/24, 203.23.31.0/24, 203.25.41.0/24, 203.25.42.0/24, 203.53.30.232, 203.166.118.195 }"
ford_sites="{ 64.14.29.50, 136.1.25.105, 136.2.12.190, 136.1.241.107 }"
holden_sites="{ 66.235.128.158, 66.235.132.121, 66.235.132.152, 72.247.49.230, 72.5.123.29, 72.247.247.88, 96.6.229.230, 148.95.0.0/16, 198.208.16.25, 198.208.16.26, 198.208.54.157, 198.208.154.157, 198.208.187.168 }"
inchape_sites="192.168.3.3"
jaguar_sites="{ 72.247.247.161, 72.247.247.176, 80.231.29.29, 96.6.230.123, 140.174.24.168, 140.174.24.201 }"
kia_sites="203.53.30.232"
mazda_sites="{ 10.3.0.0/16, 10.4.0.0/16, 19.190.18.0/24, 19.197.2.141 }"
mitsubishi_sites="{ 159.196.36.12, 159.196.36.15, 159.196.36.16, 159.196.36.125, 202.45.13.114 }"
peugeot_sites="203.53.30.233"
porsche_sites="{ 10.61.1.0/24, 10.61.248.65, 10.61.248.66, 84.21.39.0/24, 84.21.52.11, 84.21.53.11, 84.21.53.14, 84.21.53.16, 141.36.132.85, 192.168.200.34, 193.175.6.2, 193.175.6.66, 203.26.190.6, 203.26.190.226 }"
toyota_sites="{ 10.9.100.0/24, 132.147.0.0/16, 150.45.0.0/16, 192.168.42.0/24, 192.168.101.0/24, 192.168.108.0/24, 192.168.109.0/24, 192.168.206.0/24, 208.39.44.0/24, 208.39.45.0/24, 216.14.206.48 }"
volvo_sites="136.8.154.0/24"
vw_sites="{ 10.112.198.0/24, 10.152.15.0/24, 172.16.61.0/24, 210.193.223.156 }"

#--------------------------
# Manufacturer Networks END
#--------------------------

#-------------------------
# Proxy Bypass Sites START
#-------------------------
addresslink_sites="210.193.214.83"
ato_sites="203.202.41.80"
caplink_sites="203.153.237.100"
carsales_sites="{ 140.174.24.8, 140.174.24.80, 140.174.24.177, 140.174.24.218 }"
dais_sites="{ 203.94.167.209, 203.9.185.207, 203.9.185.233 }"
dealerlogic_sites="{ 203.94.176.180, 203.94.176.181 }"
fowles_sites="{ 203.166.110.40, 203.166.110.41 }"
ibmhmc_sites="{ 129.42.160.48, 129.42.160.50, 207.25.252.200, 207.25.252.205 }"
liberty_sites="{ 202.45.13.114, 202.45.13.124 }"
motorone_sites="203.35.213.102"
pickles_sites="202.58.54.235"
stgeorge_sites="{ 166.120.202.249, 203.16.39.136, 203.16.39.137, 203.16.39.138, 203.16.39.139, 203.23.44.136, 203.23.44.137, 203.23.44.138, 203.23.44.139 }"
suncorp_sites="{ 203.0.222.16, 203.0.222.101, 203.110.139.190 }"
tipt_sites="203.44.43.220"
vital_sites="{ 202.125.164.104, 67.19.91.90 }"

#-----------------------
# Proxy Bypass Sites END
#-----------------------

#---------------------
# External Sites START
#---------------------

billbuckles_ext="203.43.230.186"
klosters_ext="203.38.221.86"
surfers_ext="210.56.85.111"
surfers_ext2="210.56.85.112"
external_sites="{" $billbuckles_ext $klosters_ext $surfers_ext $surfers_ext2 "}"
external_ftp_sites="{" $billbuckles_ext $klosters_ext $surfers_ext $surfers_ext2 "}"
messagelabs="{ 62.231.131.0/24, 67.219.240.0/20, 85.158.136.0/21, 95.131.104.0/21, 117.120.16.0/21, 193.109.254.0/23, 194.106.220.0/23, 195.245.230.0/23, 216.82.240.0/20 }"

#---------------------
# External Sites END
#---------------------

# Citrix Ports
citrix_ports="{ 80, 1494 }"

# MSN Messenger Ports
msn_msg_ports="{ 1493, 1542, 1863, 1963 }"

# File Sharing PTP
torrents="{ 6881, 37001, 37002, 37003, 37000 }"
p2p="{ 1214, 5000, 5555, 6346, 777, 8331, 8875, 8888, 6257, 6699 }"
cvsup="5999"
pptp="1723"

# Instant Messaging Clients
jabber="5222"
icqaim="5190"
irc="6667" 

#++++++++++++++               
#++++++++++++++               
# Macros END
#++++++++++++++
#++++++++++++++

#++++++++++++++
#++++++++++++++
# Ruleset BEGIN
#++++++++++++++
#++++++++++++++

# Scrub
scrub in all

#--------------
# NAT/RDR BEGIN
#--------------

# Default NAT/RDR
nat on $ext_if from !($ext_if) -> ($ext_if:0)

# Inchape NAT/RDR
nat on $int_if from any to 192.168.3.3 -> $int_if  

# Audi NAT/RDR
nat on $int_if from any to 10.112.192.0/24 -> $int_if
nat on $int_if from any to 10.166.145.0/24 -> $int_if

# Redirect VW VGA Juniper
rdr on $ext_if from 61.88.114.38 to any -> $vga_juniper_ext  # VW VPN to Ext int of VGA Juniper
rdr on $ext_if from 119.225.2.78 to any -> $vga_juniper_ext  # Audi VPN to Ext int of VGA Juniper
rdr on $ext_if from 210.48.210.1 to any -> $vga_juniper_ext  # may no longer be in use, Ext int of VGA Juniper

# VW NAT/RDR
nat on $int_if from any to 10.112.198.0/24 -> $int_if
nat on $int_if from any to 10.112.230.0/24 -> $int_if
#no nat on $int_if from 10.10.9.60 to 10.152.15.0/24
nat on $int_if from any to 10.152.15.0/24 -> $int_if
nat on $int_if from any to 172.16.61.0/24 -> $int_if
nat on $int_if from any to 210.193.223.156 -> $int_if   

# Toyota NAT/RDR
nat on $int_if from any to 10.9.100.0/24 -> $int_if  
nat on $int_if from any to 132.147.0.0/16 -> $int_if  
nat on $int_if from any to 150.45.0.0/16 -> $int_if  
nat on $int_if from any to 192.168.42.0/24 -> $int_if  
nat on $int_if from any to 192.168.101.0/24 -> $int_if  
nat on $int_if from any to 192.168.108.0/24 -> $int_if  
nat on $int_if from any to 192.168.109.0/24 -> $int_if  
nat on $int_if from any to 192.168.206.0/24 -> $int_if  

# NAT for DWN ERA
nat on $b2b_if from 172.20.3.40 to 19.190.18.11 -> $b2b_if

#--------------
# NAT/RDR END
#--------------

# FTP Anchor
nat-anchor "ftp-proxy/*"
rdr-anchor "ftp-proxy/*"
rdr on $int_if proto tcp from any to any port 21 -> 127.0.0.1 port 8021
anchor "ftp-proxy/*"

#-------------------------
# Remote Connections BEGIN
#-------------------------

# AP Eagers FTP
rdr on $ext_if proto tcp from $external_ftp_sites to $ape_ftp_ext port ftp -> $bne_iis
rdr on $ext_if proto tcp from $external_ftp_sites to $ape_ftp_ext port 49151:65535 -> $bne_iis

# Carzoos FTP
rdr on $ext_if proto tcp from $external_ftp_sites to $carzoos_ftp_ext port ftp -> $bne_dax09
rdr on $ext_if proto tcp from $external_ftp_sites to $carzoos_ftp_ext port 49152:65535 -> $bne_dax09

# Citrix NFuse
rdr on $ext_if proto tcp from any to $citrix_ext port www -> $citrix_int
rdr on $ext_if proto tcp from any to $citrix_ext port 1494 -> $citrix_int

# Intranet Access
rdr on $ext_if proto tcp from $external_sites to $intranet_ext port 80 -> $intranet_int

# OWA Access
rdr on $ext_if proto tcp from any to $owa_ext port 80 -> $bne_mx1 port 80
pass in log on $ext_if proto tcp from any to $bne_mx1 port 80 
 
# SMTP Access
rdr on $ext_if proto tcp from $messagelabs to any port 25 -> localhost

# VGA pass traffic to Juniper
pass in log quick on $ext_if from 61.88.114.38 to $vga_juniper_ext keep state
pass in log quick on $ext_if from 119.225.2.78 to $vga_juniper_ext keep state
pass in log quick on $ext_if from 210.48.210.1 to $vga_juniper_ext keep state

#-------------------------
# Remote Connections END
#-------------------------

# Default deny
block in log all

# Mark
pass out quick on $ext_if from 10.34.1.69 to any

# Deny Outgoing Dodgy ports
block out log quick on $ext_if proto { tcp, udp } from any to any port $msn_msg_ports
block out log quick on $ext_if proto { tcp, udp } from any to any port $torrents
block out log quick on $ext_if proto { tcp, udp } from any to any port $p2p
block out log quick on $ext_if proto { tcp, udp } from any to any port $cvsup
block out log quick on $ext_if proto { tcp, udp } from any to any port $jabber
block out log quick on $ext_if proto { tcp, udp } from any to any port $icqaim
block out log quick on $ext_if proto { tcp, udp } from any to any port $irc
block out log quick on $ext_if proto { tcp, udp } from any to any port $pptp

#-------------------------
# Remote Connections BEGIN
#-------------------------

# AP Eagers FTP
pass in log quick on $ext_if proto tcp from $external_ftp_sites to $bne_iis port ftp
pass in log quick on $ext_if proto tcp from $external_ftp_sites to $bne_iis port > 49151

# Carzoos FTP
pass in log quick on $ext_if proto tcp from $external_ftp_sites to $bne_dax09 port ftp 
pass in log quick on $ext_if proto tcp from $external_ftp_sites to $bne_dax09 port > 49151 

# Citrix NFuse
pass in log quick on $ext_if proto tcp from any to $citrix_int port $citrix_ports

# email from Messagelabs
pass in quick on $ext_if proto tcp from $messagelabs to any port 25 keep state

# Intranet Access
pass in quick on $ext_if proto tcp from $external_sites to $intranet_int port www 

# OWA Access
pass in quick on $ext_if proto tcp from any to $bne_mx1 port www

#-------------------------
# Remote Connections END
#-------------------------

# Allow all traffic out. 
pass out all

# Allow all ERA traffic
pass quick on $dms_if no state

# Allow all B2B traffic
pass quick on $b2b_if no state

# Pass in internal traffic
pass on $int_if no state
pass out on $int_if from any to any keep state

# Allow sites to bypass proxy
pass in quick on $int_if proto { tcp, udp } from any to $addresslink_sites port $inet_ports
pass in quick on $int_if proto { tcp, udp } from any to $ato_sites port $inet_ports
pass in quick on $int_if proto { tcp, udp } from any to $caplink_sites port $inet_ports
pass in quick on $int_if proto { tcp, udp } from any to $carsales_sites port $inet_ports
pass in quick on $int_if proto { tcp, udp } from any to $dais_sites port $inet_ports
pass in quick on $int_if proto { tcp, udp } from any to $dealerlogic_sites port $inet_ports
pass in quick on $int_if proto { tcp, udp } from any to $fowles_sites port $inet_ports
pass in quick on $int_if proto { tcp, udp } from any to $ibmhmc_sites port $inet_ports
pass in quick on $int_if proto { tcp, udp } from any to $liberty_sites port $inet_ports
pass in quick on $int_if proto { tcp, udp } from any to $motorone_sites port $inet_ports
pass in quick on $int_if proto { tcp, udp } from any to $pickles_sites port $inet_ports
pass in quick on $int_if proto { tcp, udp } from any to $stgeorge_sites port $inet_ports
pass in quick on $int_if proto { tcp, udp } from any to $suncorp_sites port $inet_ports
pass in quick on $int_if proto { tcp, udp } from any to $tipt_sites port $inet_ports
pass in quick on $int_if proto { tcp, udp } from any to $vital_sites port $inet_ports

# Allow Manufacturer web traffic to bypass proxy
pass in quick on $int_if proto { tcp, udp } from any to $audi_sites port $inet_ports
pass in quick on $int_if proto { tcp, udp } from any to $autogrid_sites port $inet_ports
pass in quick on $int_if proto { tcp, udp } from any to $bma_sites port $inet_ports
pass in quick on $int_if proto { tcp, udp } from any to $capital_finance port $inet_ports
pass in quick on $int_if proto { tcp, udp } from any to $citroen_sites port $inet_ports
pass in quick on $int_if proto { tcp, udp } from any to $dealerlink_sites port $inet_ports
pass in quick on $int_if proto { tcp, udp } from any to $ford_sites port $inet_ports
pass in quick on $int_if proto { tcp, udp } from any to $holden_sites port $inet_ports
pass in quick on $int_if proto { tcp, udp } from any to $inchape_sites port $inet_ports
pass in quick on $int_if proto { tcp, udp } from any to $jaguar_sites port $inet_ports
pass in quick on $int_if proto { tcp, udp } from any to $kia_sites port $inet_ports
pass in quick on $int_if proto { tcp, udp } from any to $mazda_sites port $inet_ports
pass in quick on $int_if proto { tcp, udp } from any to $mitsubishi_sites port $inet_ports
pass in quick on $int_if proto { tcp, udp } from any to $peugeot_sites port $inet_ports
pass in quick on $int_if proto { tcp, udp } from any to $porsche_sites port $inet_ports
pass in quick on $int_if proto { tcp, udp } from any to $toyota_sites port $inet_ports
pass in quick on $int_if proto { tcp, udp } from any to $volvo_sites port $inet_ports
pass in quick on $int_if proto { tcp, udp } from any to $vw_sites port $inet_ports

# Allow/Block internet traffic
pass in quick on $int_if proto { tcp, udp } from $proxy_svrs to any port $inet_ports
block in on $int_if proto { tcp, udp } from any to any port $inet_ports

# Antispoof loopback
antispoof quick for { lo $int_if }

# Allow DNS transfers and queries
pass in quick on $int_if proto { tcp, udp } from any port 53 to any keep state
pass in quick on $dms_if proto { tcp, udp } from any port 53 to any keep state
pass in quick on $b2b_if proto { tcp, udp } from any port 53 to any keep state
pass in quick on $int_if proto { tcp, udp } from any to any port 53 keep state
pass in quick on $dms_if proto { tcp, udp } from any to any port 53 keep state
pass in quick on $b2b_if proto { tcp, udp } from any to any port 53 keep state

# By default, do not permit remote connections to X11
#block in on ! lo0 proto tcp from any to any port 6000

#++++++++++++++
#++++++++++++++              
# Ruleset END
#++++++++++++++              
#++++++++++++++

